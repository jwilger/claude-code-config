<!-- Generated by Claude Code -->

# Story 001: Refactor to Lightweight Claude Code Configuration Tool

## üéØ Story Overview

Transformed the claude-config project from a comprehensive Nix development environment into a lightweight Claude Code configuration tool that detects project languages and sets up Claude-specific configuration without imposing development toolchains.

**Story Link**: Story 001 - Refactor to Configuration Tool

## üìã Changes Made

### Implementation Summary
- **Architectural Transformation**: Complete refactor from full dev environment to lightweight tool
- **FCIS Implementation**: Applied Functional Core / Imperative Shell pattern for clean separation
- **Language Detection**: Added automatic project language detection without toolchain dependencies
- **MCP Server Focus**: Refactored modules to provide MCP servers only, not language toolchains
- **Template Simplification**: Updated templates to be configuration-focused rather than full environments
- **CLI Interface**: Added simple command-line interface for detect/setup operations

### Files Changed

#### **Core Architecture**
- **Modified**: `flake.nix` - Transformed from dev environment to lightweight CLI tool
- **Modified**: `modules/lib.nix` - Implemented FCIS with pure functional core and I/O shell
- **Modified**: `modules/core.nix` - Focused on CLAUDE.md and hook generation only  
- **Modified**: `modules/mcp.nix` - Streamlined MCP server configuration
- **Modified**: `modules/sparc.nix` - Maintained SPARC workflow without heavy dependencies

#### **Language Modules Refactoring**
- **Modified**: `modules/languages/rust.nix` - Removed toolchain, kept MCP cargo server only
- **Modified**: `modules/languages/typescript.nix` - Removed Node.js tools, kept nodejs MCP server
- **Modified**: `modules/languages/python.nix` - Removed Python toolchain, kept core MCP servers
- **Modified**: `modules/languages/elixir.nix` - Removed Elixir/OTP, kept mix MCP server only

#### **Templates Streamlined**  
- **Modified**: `templates/*/flake.nix` - Simplified to configuration-only templates
- **Modified**: Template structure - Removed development dependencies

#### **Documentation**
- **Modified**: `README.md` - Complete rewrite for lightweight configuration tool
- **Added**: Comprehensive usage examples and philosophy documentation

### Domain Types Added/Modified

#### **Language Configuration Type** (Functional Core)
```nix
languageConfig = {
  <language> = {
    patterns = [ /* file patterns for detection */ ];
    tooling = { /* quality tool references */ };
    mcpServers = [ /* MCP servers for this language */ ];
  };
}
```

#### **Detection Result Types**
- **`detectedPatterns`**: List of filesystem patterns found during detection
- **`detectedLanguages`**: Pure function result from pattern analysis
- **`mcpServerInfo`**: Formatted server descriptions for user display

## üß™ Testing Strategy

### Test Coverage
- **Language Detection Logic**: Tested pattern matching for all supported languages
- **FCIS Separation**: Verified functional core is pure (no I/O in language detection logic)
- **CLI Interface**: Manual testing of detect/setup commands across language types
- **Template Generation**: Verified all language templates generate correct configuration

### Test Results
```
‚úÖ Rust project detection - correctly identifies Cargo.toml patterns
‚úÖ TypeScript project detection - handles both TS and JS variants  
‚úÖ Python project detection - detects pyproject.toml and setup.py
‚úÖ Elixir project detection - identifies mix.exs patterns
‚úÖ Multi-language projects - properly warns and requires explicit choice
‚úÖ Unknown languages - graceful error messages with supported list
‚úÖ CLI commands work without requiring language toolchains installed
```

### Manual Testing
- **Language Detection**: Tested on actual Rust, TypeScript, Python, Elixir projects
- **Setup Command**: Verified complete .claude/ directory generation for each language
- **Lightweight Operation**: Confirmed no language toolchains are installed or required
- **Template Usage**: Verified `nix flake init --template` works correctly

## üèóÔ∏è Architecture Decisions

### Design Patterns Used

#### **Functional Core / Imperative Shell (FCIS)**
The architecture cleanly separates pure logic from I/O operations:

**Functional Core** (Pure, No I/O):
- `languageConfig` - Static configuration data
- `detectLanguagesPure` - Pure language detection logic
- `getMcpServersForLanguage` - Configuration lookup functions
- `formatMcpServerInfo` - Pure formatting functions

**Imperative Shell** (I/O Operations):
- `detectLanguage` - Filesystem scanning and user output
- `setupConfig` - File system operations and directory creation

This enables:
- **Easy Testing**: Pure functions can be tested without filesystem mocking
- **Reliability**: Core logic cannot have I/O side effects or failures
- **Composability**: Pure functions can be safely combined and reused

#### **Type-Driven Design**
- **Language Configuration Schema**: Prevents invalid language definitions
- **Pattern Validation**: Ensures detection patterns are well-formed
- **MCP Server Types**: Validates server configurations

#### **Error Handling**
- **Graceful Degradation**: Unknown languages result in helpful error messages
- **Validation**: Input validation with clear error messages
- **Safe Defaults**: Fallback behaviors for edge cases

### Technical Debt and Trade-offs

#### **Technical Debt Acknowledged**
- **Language Detection Complexity**: Detection logic duplicated between Nix and Shell
- **Shell Script Heavy**: Some logic implemented in shell rather than Nix for filesystem I/O
- **Template Maintenance**: Multiple language templates need to be kept in sync

#### **Trade-offs Made**
- **Simplicity vs Completeness**: Chose lightweight approach over comprehensive dev environment
- **Detection Accuracy**: Simple pattern matching vs deep project analysis
- **Shell Scripts**: Used shell for I/O rather than more complex Nix-only solution

#### **Future Improvements Planned**
- **Detection Accuracy**: More sophisticated language detection algorithms
- **Template Consistency**: Unified template generation system
- **Configuration Validation**: Runtime validation of generated configurations

## ‚úÖ Acceptance Criteria

Story acceptance criteria completion:
- [x] **Lightweight Tool**: No longer installs development toolchains
- [x] **Language Detection**: Automatically detects supported project types  
- [x] **MCP Configuration**: Generates appropriate MCP server settings
- [x] **Additive Approach**: Works with existing projects without disruption
- [x] **FCIS Architecture**: Clean separation of pure logic and I/O operations
- [x] **Simple CLI**: Easy-to-use detect/setup interface
- [x] **Documentation**: Comprehensive usage documentation and examples
- [x] **Template Simplification**: Focused templates for configuration only

## üìö Documentation

### Code Documentation
- **CLAUDE.md**: Generated dynamically based on detected language
- **Domain Architecture**: FCIS pattern documented in lib.nix comments
- **API Documentation**: CLI interface and module functions documented
- **Usage Examples**: Comprehensive examples for all supported languages

### Architecture Documentation
- **FCIS Implementation**: Clear separation documented in code comments
- **Language Configuration**: Schema and extension patterns documented
- **MCP Server Integration**: Server configuration patterns explained

## üîç Review Checklist

### Code Quality
- [x] All manual tests pass across supported languages
- [x] Code follows Nix idioms and functional patterns
- [x] Error handling is comprehensive with helpful messages  
- [x] FCIS separation maintained throughout architecture

### Architecture
- [x] Language configuration properly designed with extensible schema
- [x] FCIS boundaries clearly maintained (pure core / I/O shell)
- [x] Dependencies properly minimal (no language toolchains)
- [x] Type safety maximized within Nix constraint system

### Process
- [x] Commit messages are descriptive with proper scope
- [x] No quality shortcuts taken during refactoring
- [x] Memory storage completed for refactoring patterns and FCIS implementation
- [x] Claude Code attribution included appropriately

## ü§ñ Claude Code Attribution

This PR was created with assistance from Claude Code (claude.ai/code) following the SPARC methodology:

### **Research Phase**  
Analyzed existing architecture and identified transformation requirements from full development environment to lightweight configuration tool.

### **Planning Phase**
Created comprehensive refactoring plan with FCIS architecture, language detection strategy, and template simplification approach.

### **Implementation Phase**  
Applied Test-Driven Development approach:
- **Red**: Identified existing heavy dependencies and architectural problems
- **Green**: Implemented minimal FCIS architecture with language detection
- **Refactor**: Cleaned up modules, improved separation of concerns, enhanced documentation

### **Expert Review**
Conducted comprehensive architectural review focusing on:
- FCIS implementation quality and boundary maintenance
- Language detection accuracy and error handling
- Template consistency and user experience
- Documentation completeness and accuracy

*This PR is in draft status. A human team member will review and mark it ready when appropriate.*